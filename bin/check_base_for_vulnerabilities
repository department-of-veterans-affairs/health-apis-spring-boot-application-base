#!/usr/bin/env bash

#
# Ensure that we fail fast on any issues.
#
set -euo pipefail

#
# Please look at format of QUALYS_SCAN_RESULT.  This will go through and prase all sev*Count for confrimed, potential,
# patchAvailability.confirmed, and patchAvailability.potential)
#

sumOfScans(){
    base=$1
    #echo "13"
    echo $(tr '\t' '+' <<< $(echo $QUALYS_SCAN_RESULT | jq -r "[.$base.sev1Count,.$base.sev2Count,.$base.sev3Count,.$base.sev4Count,.$base.sev5Count] | @tsv") | bc)
}

checkConfirmedVulnerabilities(){
    if [ $(sumOfScans "vulnSummary.confirmed") != 0 ]
    then
        if [ $(sumOfScans "vulnSummary.patchAvailability.confirmed") != 0 ]
            then 
                echo "We should rebuild"
                REBUILD=true
            else
                echo "We should NOT rebuild"
        fi
    else
        echo "We should NOT rebuild"
    fi
}

checkPotentialVulnerabilities(){
    if [ $(sumOfScans "vulnSummary.potential") != "0" ]
    then
        if [ $(sumOfScans "vulnSummary.patchAvailability.potential") != 0 ]
            then 
                echo "We should rebuild"
                REBUILD=true
            else 
                echo "We should NOT rebuild"
        fi
    else
        echo "We should NOT rebuild"
    fi
}

DOCKER_REPO=$1
TAG=$2
REBUILD=false

test -n $TAG
test -n $DOCKER_REPO
test -n $QUALYS_USERNAME
test -n $QUALYS_PASSWORD

#
# Pull the latest tag of the Docker Base and check to see how many vulnerabilities it has
# The Qualy's scans of the parent repos occur nightly at midnight so they should ne up to date.
#

echo "Pulling down $DOCKER_REPO:$TAG to get SHA to check Qualys"
docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
docker pull $DOCKER_REPO:$TAG

# Get the SHA of the current base image and remove leading and trailing "
FULL_DOCKER_SHA=$(docker inspect $DOCKER_REPO:$TAG | jq .[0].Id | tr -d '"')

# Strip off 'sha:' from the response from docker insepct
DOCKER_SHA="${FULL_DOCKER_SHA#*:}"

# Make Request to our Qualys Container scans to get a list of vulnerabilities back
QUALYS_ENDPOINT=https://qualysapi.qg3.apps.qualys.com/csapi/v1.1/images/$DOCKER_SHA/vuln
QUALYS_SCAN_RESULT=$(curl -u $QUALYS_USERNAME:$QUALYS_PASSWORD $QUALYS_ENDPOINT)

if [ $(echo $QUALYS_SCAN_RESULT | jq ".errorCode") == "null" ]
then
    echo "Found Image in Qualys Scans"
else
    echo "Cannot get vulnerability information"
    echo "Error Message: $(cat $QUALYS_SCAN_RESULT | jq '.message')"
    exit 1
fi

# Display the number of vulnerabilities found in the qualys scan
echo $QUALYS_SCAN_RESULT | jq

checkConfirmedVulnerabilities
checkPotentialVulnerabilities

export REBUILD_STATUS=$REBUILD